---
title: "RabbitMQ阻塞的处理"
author: "Yu Nongxin"
date: "2021-01-19"
categories: ["Programming"]
tags: ["RabbitMQ"]
slug: "resolve-rabbitmq-block"
thumbnailImagePosition: left
thumbnailImage: "banners/rabbitmq.jpg"
---

RabbitMQ是一款使用非常广泛的消息中间件，拥有兔子一样快的性能，而且自带可视化管理界面，对用户非常友好。

<!--more-->

在电商系统中，RabbitMQ通常用来对高流量场景进行削峰，或者是处理一些异步业务，或者是对应用解耦。在广泛应用RabbitMQ的同时，我们还要具备解决RabbitMQ问题的能力。我本次遇到的消息队列阻塞场景是一个消息推送功能突然失效，导致好几天的消息推送没有正常运转。在发现问题后，首先就通过RabbitMQ的控制台找到这个队列，发现Ready中有6000+消息，unack有2个消息，说明整个队列被阻塞了，2个消息没有正确获得消费者的返回。接下来就需要去消费者找问题了。

在1月9号之前，推送服务都是正常运转的，说明是有某些突发情况导致了消费者不能正常返回ack。通过查看1月9号消费者服务的日志，发现消费者在调用某个微服务时返回失败的信息，而在消费者中没有考虑到对此类失败的处理，而且通常情况下这个调用时不会出现失败的情况。那么继续深入，查看调用微服务的日志，发现问题出现在数据库查询，本应该保证唯一性的数据出现了两条记录，导致程序运行异常。找到问题出在哪了，就要开始解决了，检查数据源发现，来自内部系统的数据没有按正确的业务逻辑提供数据，导致脏数据产生，快速处理就是在查询是过滤掉脏数据，保证业务获取数据的唯一性。修改完成后，快速发布，重启微服务和消费者，RabbitMQ的积压消息立刻就开始处理，1分多钟就把6000+的消息处理完了。

每一个线上问题的产生，往往都需要快速定位，快速解决。如何通过日志和监控提供的信息快速定位问题，快速解决问题是开发人员必须要具备的。这一次RabbitMQ的阻塞，是我第一次解决消息中间件的问题，不过排查问题的思路清晰，让我能够快速找到问题的根源，并迅速解决，也让我使用消息中间件的经验更丰富了。
